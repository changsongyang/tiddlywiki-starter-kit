{"title":"$:/plugins/oeyoews/mermaid-widget","description":"mermaid-widget","author":"oeyoews","version":"0.1.0","core-version":">=5.3.0","type":"application/json","plugin-type":"plugin","name":"mermaid-widget","meat#disabled":"yes","qrcode":"yes","created":"2024-01-11","list":"readme","dependents":"","text":"{\"tiddlers\":{\"$:/plugins/oeyoews/mermaid-widget/readme\":{\"title\":\"$:/plugins/oeyoews/mermaid-widget/readme\",\"text\":\"## Mermaid widget\\n\\n> 提供 mermaid widget.\\n\\n```html\\n<$mermaid2 rendertype=\\\"png\\\" theme=\\\"forest\\\">\\ngraph LR;\\na[Another mermaid widget] -.-> b[[mermaid-widget]]\\n</$mermaid2>\\n```\\n\\n<$mermaid2 rendertype=\\\"png\\\" theme=\\\"forest\\\">\\ngraph LR;\\na[Another mermaid widget] -.-> b[[mermaid-widget]]\\n</$mermaid2>\",\"type\":\"text/markdown\",\"description\":\"mermaid-widget\"},\"$:/plugins/oeyoews/mermaid-widget/widget.js\":{\"title\":\"$:/plugins/oeyoews/mermaid-widget/widget.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/mermaid-widget/widget.js\\ntype: application/javascript\\nmodule-type: widget\\n\\nblockquote widget\\n\\n\\\\*/\\nconst{widget:e}=require(\\\"$:/core/modules/widgets/widget.js\\\");exports.mermaid2=class extends e{constructor(e,t){super(e,t),this.mermaid,this.theme=\\\"default\\\",this.rendertype=\\\"svg\\\",this.tiny=!1}async render(e,t){this.computeAttributes(),this.execute();const i=this.document.createElement(\\\"div\\\");if(i.isTiddlyWikiFakeDom)return;const{theme:r,rendertype:s}=this.attributes;r&&(this.theme=r),s&&(this.rendertype=s),this.getmermaid(),e.insertBefore(i,t),this.renderChildren(i,null),this.domNodes.push(i),i.outerHTML=await this.renderMermaid(this.removeEmptyLines(i.textContent.trim()))}removeEmptyLines(e){return e.replace(/^\\\\s*[\\\\r\\\\n]/gm,\\\"\\\")}getconfig(e){return{securityLevel:\\\"loose\\\",theme:e,startOnLoad:!1,htmlLabels:!0}}getmermaid(){if(window.mermaid)this.tiny=!0,this.mermaid=window.mermaid;else{const e=\\\"mermaid-930.min.js\\\",t=$tw.modules.types.library.hasOwnProperty(e);try{const{mermaidAPI:i}=t?require(e):require(\\\"$:/plugins/orange/mermaid-tw5/mermaid.min.js\\\");this.mermaid=i}catch(e){console.warn(e)}}}async renderMermaid(e){const t=\\\"mermaid_\\\"+this.generateRandomString(5);let i,r=\\\"\\\",s=\\\"\\\";try{if(this.tiny){this.mermaid.initialize(this.getconfig(this.theme));const{svg:i}=await this.mermaid.render(t,e);if(r=i,\\\"png\\\"===this.rendertype){const e=this.document.getElementById(t);e&&(s=e.style.maxWidth)}}else this.mermaid.initialize(this.getconfig(this.theme)),this.mermaid.render(t,e,(e=>{if(r=e,\\\"png\\\"===this.rendertype){const e=this.document.getElementById(t);e&&(s=e.style.maxWidth)}}));if(!r)return`<pre style=\\\"color:#ff1919;\\\">${e}</pre>`;switch(this.rendertype){case\\\"svg\\\":default:i=this.getHTML(r);break;case\\\"png\\\":i=this.getHTML(`<img src=\\\"data:image/svg+xml,${encodeURIComponent(r)}\\\" style=\\\"max-width:${s};\\\" />`)}return i}catch(e){const i=document.getElementById(\\\"d\\\"+t);return i&&i.parentNode.removeChild(i),`<pre style=\\\"color:#ff1919;\\\">${e.toString().split(\\\"\\\\n\\\").slice(1).join(\\\"\\\\n\\\")||e}</pre>`}}generateRandomString(e){return Array.from({length:e},(()=>\\\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\\\".charAt(Math.floor(62*Math.random())))).join(\\\"\\\")}refresh(){return!1}getHTML(e){return`<div style=\\\"text-align:center;\\\">${e}</div>`}};\",\"type\":\"application/javascript\",\"module-type\":\"widget\"}}}"}